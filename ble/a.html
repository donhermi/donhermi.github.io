<!doctype html>

<html lang="en">
  <head>

    <meta name="description" content="Sample illustrating the use of Web Bluetooth / Discover Services & Characteristics.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Web Bluetooth / Discover Services & Characteristics Sample</title>


  </head>

  <body>
    <img class="pageIcon" src="icon.png">
    <h1>Web Bluetooth / Discover Services & Characteristics Sample</h1>
    <p class="availability">
      Available in <a target="_blank" href="https://www.chromestatus.com/feature/5264933985976320">Chrome 53+</a> |
      <a target="_blank" href="https://github.com/googlechrome/samples/blob/gh-pages/web-bluetooth/discover-services-and-characteristics.html">View on GitHub</a> |
      <a  href="index.html">Browse Samples</a>
    </p>
    <p>The <a href="https://developers.google.com/web/updates/2015/07/interact-with-ble-devices-on-the-web">Web Bluetooth
  API</a> lets websites discover and communicate with devices over the
Bluetooth 4 wireless standard using the Generic Attribute Profile (GATT). It is
currently partially implemented in Android M, Chrome OS, Linux, and Mac.</p>

<script>
  if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

<script>
  window.addEventListener('DOMContentLoaded', function() {
    const searchParams = new URL(location).searchParams;
    const inputs = Array.from(document.querySelectorAll('input[id]'));

    inputs.forEach(input => {
      if (searchParams.has(input.id)) {
        if (input.type == 'checkbox') {
          input.checked = searchParams.get(input.id);
        } else {
          input.value = searchParams.get(input.id);
          input.blur();
        }
      }
      if (input.type == 'checkbox') {
        input.addEventListener('change', function(event) {
          const newSearchParams = new URL(location).searchParams;
          if (event.target.checked) {
            newSearchParams.set(input.id, event.target.checked);
          } else {
            newSearchParams.delete(input.id);
          }
          history.replaceState({}, '', Array.from(newSearchParams).length ?
              location.pathname + '?' + newSearchParams : location.pathname);
        });
      } else {
        input.addEventListener('input', function(event) {
          const newSearchParams = new URL(location).searchParams;
          if (event.target.value) {
            newSearchParams.set(input.id, event.target.value);
          } else {
            newSearchParams.delete(input.id);
          }
          history.replaceState({}, '', Array.from(newSearchParams).length ?
              location.pathname + '?' + newSearchParams : location.pathname);
        });
      }
    });
  });
</script>



<form>
  <input id="optionalServices" type="text" list="services" size=40 placeholder="Bluetooth Services (e.g. generic_access, 0x1234)">
  <button>Discover services & characteristics</button>
</form>

<datalist id="services">
  <option value="00001231-0000-1000-8000-00805f9b34fb">00001231-0000-1000-8000-00805f9b34fb</option>
  <option value="weight_scale">weight_scale</option>
</datalist>



<h3>Live Output</h3>
<div id="output" class="output">
  <div id="content"></div>
  <div id="status"></div>
  <pre id="console.log"></pre>
</div>




<script>function onButtonClick() {
  // Validate services UUID entered by user first.
  let optionalServices = document.querySelector('#optionalServices').value
    .split(/, ?/).map(s => s.startsWith('0x') ? parseInt(s) : s)
    .filter(s => s && BluetoothUUID.getService);

  console.log('Requesting any Bluetooth Device...');
  navigator.bluetooth.requestDevice({
      filters: [{
      name: 'UART Service'
      }],
      //optionalServices: ['00001232-0000-1000-8000-00805f9b34fb']
      
      //name: 'UART Service' //<- Prefer filters to save energy & show relevant devices.
      //acceptAllDevices: true,
      optionalServices: optionalServices
      })
  .then(device => {
    console.log('Connecting to GATT Server...');
    return device.gatt.connect();
  })
  .then(server => {
    // Note that we could also get all services that match a specific UUID by
    // passing it to getPrimaryServices().
    console.log('Getting Services...');
    return server.getPrimaryServices();
  })
  .then(services => {
    console.log('Getting Characteristics...');
    let queue = Promise.resolve();
    services.forEach(service => {
      queue = queue.then(_ => service.getCharacteristics().then(characteristics => {
        console.log('> Service: ' + service.uuid);
        characteristics.forEach(characteristic => {
          console.log('>> Characteristic: ' + characteristic.uuid + ' ' +
              getSupportedProperties(characteristic));
              var resetEnergyExpended = 1;
              characteristic.writeValue(resetEnergyExpended);
              console.log(resetEnergyExpended);
        });
      }));
    });
    return queue;
  })
  .catch(error => {
    console.log('Argh! ' + error);
  });
}

</script>  




  </body>
</html>
